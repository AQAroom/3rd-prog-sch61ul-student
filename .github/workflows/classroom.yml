name: "BankAccount Class Tests"
on:
  push:
  repository_dispatch:
permissions:
  checks: write
  actions: read
  contents: read

jobs:
  # JOB 1: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ ÐºÐ»Ð°ÑÑÐ°
  run-structure-tests:
    name: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ BankAccount
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Create tests directory
        run: mkdir -p tests
      
      - name: Download structure test script
        run: |
          curl -o tests/check_structure.py https://raw.githubusercontent.com/your-org/bankaccount-tests/main/tests/check_structure.py
          # Ð˜Ð›Ð˜ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð», ÐµÑÐ»Ð¸ Ð¾Ð½ ÐµÑÑ‚ÑŒ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸
      
      - name: Check class structure
        id: structure_test
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ BankAccount"
          command: "python tests/check_structure.py"
          expected-output: "SUCCESS: Ð’ÑÐµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹"
          comparison-method: contains
          timeout: 10
          max-score: 50

  # JOB 2: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ð²Ð¾Ð´Ð°-Ð²Ñ‹Ð²Ð¾Ð´Ð°
  run-io-tests:
    name: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ð²Ð¾Ð´Ð°-Ð²Ñ‹Ð²Ð¾Ð´Ð° BankAccount
    runs-on: ubuntu-latest
    needs: run-structure-tests
    if: github.actor != 'github-classroom[bot]'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Create tests directory
        run: mkdir -p tests
      
      - name: Download I/O test script
        run: |
          curl -o tests/test_bank.py https://raw.githubusercontent.com/your-org/bankaccount-tests/main/tests/test_bank.py
      
      # Test 1: Deposit
      - name: "Ð¢ÐµÑÑ‚ 1 - ÐŸÐ¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÑÑ‡ÐµÑ‚Ð°"
        id: test1
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: "ÐŸÐ¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÑÑ‡ÐµÑ‚Ð°"
          command: "python tests/test_bank.py"
          input: |
            1000
            200
          expected-output: |
            Ð‘Ð°Ð»Ð°Ð½Ñ ÑÑ‡Ñ‘Ñ‚Ð°: 1000 ÐµÐ´Ð¸Ð½Ð¸Ñ†
            ÐÐ° ÑÑ‡ÐµÑ‚ Ð·Ð°Ñ‡Ð¸ÑÐ»ÐµÐ½Ð¾: 200 ÐµÐ´Ð¸Ð½Ð¸Ñ†
            Ð‘Ð°Ð»Ð°Ð½Ñ ÑÑ‡Ñ‘Ñ‚Ð°: 1200 ÐµÐ´Ð¸Ð½Ð¸Ñ†
          comparison-method: exact
          timeout: 5
          max-score: 17
      
      # Test 2: Withdrawal
      - name: "Ð¢ÐµÑÑ‚ 2 - Ð¡Ð½ÑÑ‚Ð¸Ðµ ÑÑ€ÐµÐ´ÑÑ‚Ð²"
        id: test2
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: "Ð¡Ð½ÑÑ‚Ð¸Ðµ ÑÑ€ÐµÐ´ÑÑ‚Ð²"
          command: "python tests/test_bank.py"
          input: |
            1000
            -300
          expected-output: |
            Ð‘Ð°Ð»Ð°Ð½Ñ ÑÑ‡Ñ‘Ñ‚Ð°: 1000 ÐµÐ´Ð¸Ð½Ð¸Ñ†
            Ð¡Ð¾ ÑÑ‡ÐµÑ‚Ð° ÑÐ½ÑÑ‚Ð¾: 300 ÐµÐ´Ð¸Ð½Ð¸Ñ†
            Ð‘Ð°Ð»Ð°Ð½Ñ ÑÑ‡Ñ‘Ñ‚Ð°: 700 ÐµÐ´Ð¸Ð½Ð¸Ñ†
          comparison-method: exact
          timeout: 5
          max-score: 17
      
      # Test 3: Insufficient funds
      - name: "Ð¢ÐµÑÑ‚ 3 - ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÑ€ÐµÐ´ÑÑ‚Ð²"
        id: test3
        uses: classroom-resources/autograding-io-grader@v1
        with:
          test-name: "ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÑ€ÐµÐ´ÑÑ‚Ð²"
          command: "python tests/test_bank.py"
          input: |
            1000
            -1100
          expected-output: |
            Ð‘Ð°Ð»Ð°Ð½Ñ ÑÑ‡Ñ‘Ñ‚Ð°: 1000 ÐµÐ´Ð¸Ð½Ð¸Ñ†
            ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÑ€ÐµÐ´ÑÑ‚Ð² Ð½Ð° ÑÑ‡ÐµÑ‚Ðµ
            Ð‘Ð°Ð»Ð°Ð½Ñ ÑÑ‡Ñ‘Ñ‚Ð°: 1000 ÐµÐ´Ð¸Ð½Ð¸Ñ†
          comparison-method: exact
          timeout: 5
          max-score: 16

  # JOB 3: Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
  generate-report:
    name: Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
    runs-on: ubuntu-latest
    needs: [run-structure-tests, run-io-tests]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Extract Scores
        id: extract_scores
        run: |
          # Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð´ÐµÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð²
          decode_and_get_score() {
            local encoded_result="$1"
            if [ -z "$encoded_result" ] || [ "$encoded_result" = "null" ]; then
              echo "0"
              return
            fi
            
            echo "$encoded_result" | base64 -d | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    if 'tests' in data and len(data['tests']) > 0:
        print(data['tests'][0]['score'])
    else:
        print('0')
except:
    print('0')
" 2>/dev/null || echo "0"
          }
          
          # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð±Ð°Ð»Ð»Ñ‹
          STRUCTURE_SCORE=$(decode_and_get_score '${{ needs.run-structure-tests.outputs.result }}')
          TEST1_SCORE=$(decode_and_get_score '${{ needs.run-io-tests.outputs.test1-result }}')
          TEST2_SCORE=$(decode_and_get_score '${{ needs.run-io-tests.outputs.test2-result }}')
          TEST3_SCORE=$(decode_and_get_score '${{ needs.run-io-tests.outputs.test3-result }}')
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼
          echo "structure_score=$STRUCTURE_SCORE" >> $GITHUB_OUTPUT
          echo "test1_score=$TEST1_SCORE" >> $GITHUB_OUTPUT
          echo "test2_score=$TEST2_SCORE" >> $GITHUB_OUTPUT
          echo "test3_score=$TEST3_SCORE" >> $GITHUB_OUTPUT
          
          TOTAL=$((STRUCTURE_SCORE + TEST1_SCORE + TEST2_SCORE + TEST3_SCORE))
          echo "total_points=$TOTAL" >> $GITHUB_OUTPUT
          
          echo "STRUCTURE_SCORE=$STRUCTURE_SCORE" >> $GITHUB_ENV
          echo "TEST1_SCORE=$TEST1_SCORE" >> $GITHUB_ENV
          echo "TEST2_SCORE=$TEST2_SCORE" >> $GITHUB_ENV
          echo "TEST3_SCORE=$TEST3_SCORE" >> $GITHUB_ENV
          echo "TOTAL_POINTS=$TOTAL" >> $GITHUB_ENV
      
      - name: Generate Test Report
        run: |
          # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
          STRUCTURE_SCORE="${STRUCTURE_SCORE:-0}"
          TEST1_SCORE="${TEST1_SCORE:-0}"
          TEST2_SCORE="${TEST2_SCORE:-0}"
          TEST3_SCORE="${TEST3_SCORE:-0}"
          TOTAL_POINTS="${TOTAL_POINTS:-0}"
          
          STRUCTURE_MAX=50
          TEST1_MAX=17
          TEST2_MAX=17
          TEST3_MAX=16
          MAX_POINTS=$((STRUCTURE_MAX + TEST1_MAX + TEST2_MAX + TEST3_MAX))
          
          # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
          echo "## ðŸ¦ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸: ÐšÐ»Ð°ÑÑ BankAccount" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ ÐºÐ»Ð°ÑÑÐ°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° | Ð‘Ð°Ð»Ð»Ñ‹ | ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ | Ð¡Ñ‚Ð°Ñ‚ÑƒÑ |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "$STRUCTURE_SCORE" -eq "$STRUCTURE_MAX" ]; then
            STATUS="âœ…"
          else
            STATUS="âŒ"
          fi
          echo "| **Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° ÐºÐ»Ð°ÑÑÐ°** | $STRUCTURE_SCORE | $STRUCTURE_MAX | $STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ§ª Ð¢ÐµÑÑ‚Ñ‹ Ð²Ð²Ð¾Ð´Ð°-Ð²Ñ‹Ð²Ð¾Ð´Ð°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Ð¢ÐµÑÑ‚ | Ð‘Ð°Ð»Ð»Ñ‹ | ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ | Ð¡Ñ‚Ð°Ñ‚ÑƒÑ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "$TEST1_SCORE" -eq "$TEST1_MAX" ]; then
            STATUS1="âœ…"
          else
            STATUS1="âŒ"
          fi
          echo "| **ÐŸÐ¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÑÑ‡ÐµÑ‚Ð°** | $TEST1_SCORE | $TEST1_MAX | $STATUS1 |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$TEST2_SCORE" -eq "$TEST2_MAX" ]; then
            STATUS2="âœ…"
          else
            STATUS2="âŒ"
          fi
          echo "| **Ð¡Ð½ÑÑ‚Ð¸Ðµ ÑÑ€ÐµÐ´ÑÑ‚Ð²** | $TEST2_SCORE | $TEST2_MAX | $STATUS2 |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$TEST3_SCORE" -eq "$TEST3_MAX" ]; then
            STATUS3="âœ…"
          else
            STATUS3="âŒ"
          fi
          echo "| **ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÑ€ÐµÐ´ÑÑ‚Ð²** | $TEST3_SCORE | $TEST3_MAX | $STATUS3 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Ð˜Ñ‚Ð¾Ð³" >> $GITHUB_STEP_SUMMARY
          echo "**Ð’ÑÐµÐ³Ð¾ Ð±Ð°Ð»Ð»Ð¾Ð²: $TOTAL_POINTS / $MAX_POINTS**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$TOTAL_POINTS" -eq "$MAX_POINTS" ]; then
            echo "ðŸŽ‰ **ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°! Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹!**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°*" >> $GITHUB_STEP_SUMMARY
