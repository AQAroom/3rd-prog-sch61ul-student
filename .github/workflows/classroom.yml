name: Autograding Tests
on:
  - push
  - repository_dispatch

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  # JOB 1
  run-autograding-tests:
    name: ÐžÑ†ÐµÐ½Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð´Ð°Ð½Ð¸Ð¹
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    # Ð¢ÐµÑÑ‚ 1: ÐŸÐ¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÑÑ‡ÐµÑ‚Ð°
    - name: Ð¢ÐµÑÑ‚ 1 - ÐŸÐ¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÑÑ‡ÐµÑ‚Ð°
      id: test1
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Ð¢ÐµÑÑ‚ 1 - ÐŸÐ¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÑÑ‡ÐµÑ‚Ð°
        command: python tests/test_io.py
        input: |
          1000
          200
        expected-output: |
          Ð‘Ð°Ð»Ð°Ð½Ñ ÑÑ‡Ñ‘Ñ‚Ð°: 1000 ÐµÐ´Ð¸Ð½Ð¸Ñ†
          ÐÐ° ÑÑ‡ÐµÑ‚ Ð·Ð°Ñ‡Ð¸ÑÐ»ÐµÐ½Ð¾: 200 ÐµÐ´Ð¸Ð½Ð¸Ñ†
          Ð‘Ð°Ð»Ð°Ð½Ñ ÑÑ‡Ñ‘Ñ‚Ð°: 1200 ÐµÐ´Ð¸Ð½Ð¸Ñ†
        comparison-method: exact
        timeout: 5
        max-score: 17
    
    # Ð¢ÐµÑÑ‚ 2: Ð¡Ð½ÑÑ‚Ð¸Ðµ ÑÑ€ÐµÐ´ÑÑ‚Ð²
    - name: Ð¢ÐµÑÑ‚ 2 - Ð¡Ð½ÑÑ‚Ð¸Ðµ ÑÑ€ÐµÐ´ÑÑ‚Ð²
      id: test2
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Ð¢ÐµÑÑ‚ 2 - Ð¡Ð½ÑÑ‚Ð¸Ðµ ÑÑ€ÐµÐ´ÑÑ‚Ð²
        command: python tests/test_io.py
        input: |
          1000
          -300
        expected-output: |
          Ð‘Ð°Ð»Ð°Ð½Ñ ÑÑ‡Ñ‘Ñ‚Ð°: 1000 ÐµÐ´Ð¸Ð½Ð¸Ñ†
          Ð¡Ð¾ ÑÑ‡ÐµÑ‚Ð° ÑÐ½ÑÑ‚Ð¾: 300 ÐµÐ´Ð¸Ð½Ð¸Ñ†
          Ð‘Ð°Ð»Ð°Ð½Ñ ÑÑ‡Ñ‘Ñ‚Ð°: 700 ÐµÐ´Ð¸Ð½Ð¸Ñ†
        comparison-method: exact
        timeout: 5
        max-score: 17
    
    # Ð¢ÐµÑÑ‚ 3: ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° ÑÐ½ÑÑ‚Ð¸Ñ Ð¿Ñ€Ð¸ Ð½ÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚ÐºÐµ ÑÑ€ÐµÐ´ÑÑ‚Ð²
    - name: Ð¢ÐµÑÑ‚ 3 - ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÑ€ÐµÐ´ÑÑ‚Ð²
      id: test3
      uses: classroom-resources/autograding-io-grader@v1
      with:
        test-name: Ð¢ÐµÑÑ‚ 3 - ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÑ€ÐµÐ´ÑÑ‚Ð²
        command: python tests/test_io.py
        input: |
          1000
          -1100
        expected-output: |
          Ð‘Ð°Ð»Ð°Ð½Ñ ÑÑ‡Ñ‘Ñ‚Ð°: 1000 ÐµÐ´Ð¸Ð½Ð¸Ñ†
          ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÑ€ÐµÐ´ÑÑ‚Ð² Ð½Ð° ÑÑ‡ÐµÑ‚Ðµ
          Ð‘Ð°Ð»Ð°Ð½Ñ ÑÑ‡Ñ‘Ñ‚Ð°: 1000 ÐµÐ´Ð¸Ð½Ð¸Ñ†
        comparison-method: exact
        timeout: 5
        max-score: 16

    # ÐÐžÐ’Ð«Ð™ Ð¨ÐÐ“: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ ÐºÐ»Ð°ÑÑÐ° Ñ‡ÐµÑ€ÐµÐ· AST
    - name: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ ÐºÐ»Ð°ÑÑÐ° (AST Ð°Ð½Ð°Ð»Ð¸Ð·)
      id: ast_check
      run: |
        echo "## ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ ÐºÐ»Ð°ÑÑÐ° BankAccount" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Ð˜Ñ‰ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ñ ÐºÐ»Ð°ÑÑÐ¾Ð¼ BankAccount
        BANK_FILE=""
        if [ -f "task.py" ]; then
          BANK_FILE="task.py"
        elif [ -f "solution.py" ]; then
          BANK_FILE="solution.py"
        else
          echo "âŒ ÐÐµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ñ„Ð°Ð¹Ð» Ñ ÐºÐ»Ð°ÑÑÐ¾Ð¼ BankAccount" >> $GITHUB_STEP_SUMMARY
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹: task.py, solution.py" >> $GITHUB_STEP_SUMMARY
          echo "ast_score=0" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "### Ð¤Ð°Ð¹Ð» Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°: $BANK_FILE" >> $GITHUB_STEP_SUMMARY
        
        # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÑƒ
        python check_structure.py "$BANK_FILE"
        
        # Ð§Ð¸Ñ‚Ð°ÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹
        if [ -f "ast_results.txt" ]; then
          source ast_results.txt
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ AST Ð°Ð½Ð°Ð»Ð¸Ð·Ð°:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          IFS='|' read -ra FINDING_ARRAY <<< "$findings"
          for finding in "${FINDING_ARRAY[@]}"; do
            echo "- $finding" >> $GITHUB_STEP_SUMMARY
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ð‘Ð°Ð»Ð»Ñ‹ Ð·Ð° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ ÐºÐ»Ð°ÑÑÐ°:** **$points / $max_points**" >> $GITHUB_STEP_SUMMARY
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² outputs
          AST_POINTS=$(echo "$points" | cut -d'.' -f1)
          echo "ast_points=$AST_POINTS" >> $GITHUB_OUTPUT
          echo "AST_POINTS=$AST_POINTS" >> $GITHUB_ENV
        else
          echo "âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ AST Ð°Ð½Ð°Ð»Ð¸Ð·Ð°" >> $GITHUB_STEP_SUMMARY
          echo "ast_points=0" >> $GITHUB_OUTPUT
          echo "AST_POINTS=0" >> $GITHUB_ENV
        fi
    
    - name: Extract Scores
      id: extract_scores
      run: |
        # Ð”ÐµÐºÐ¾Ð´Ð¸Ñ€ÑƒÐµÐ¼ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¸Ð· base64 Ð¸ Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ score
        decode_and_get_score() {
          local encoded_result="$1"
          echo "$encoded_result" | base64 -d | python3 -c "import sys, json; data=json.load(sys.stdin); print(data['tests'][0]['score'])"
        }
        
        # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð±Ð°Ð»Ð»Ñ‹
        TEST1_SCORE=$(decode_and_get_score '${{ steps.test1.outputs.result }}' 0)
        TEST2_SCORE=$(decode_and_get_score '${{ steps.test2.outputs.result }}' 0)
        TEST3_SCORE=$(decode_and_get_score '${{ steps.test3.outputs.result }}' 0)
        
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð±Ð°Ð»Ð»Ñ‹ Ð·Ð° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ
        AST_SCORE="${AST_POINTS:-0}"
        
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² outputs
        echo "test1_score=$TEST1_SCORE" >> $GITHUB_OUTPUT
        echo "test2_score=$TEST2_SCORE" >> $GITHUB_OUTPUT
        echo "test3_score=$TEST3_SCORE" >> $GITHUB_OUTPUT
        echo "ast_score=$AST_SCORE" >> $GITHUB_OUTPUT
        
        # Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ Ð¸Ñ‚Ð¾Ð³Ð¸
        TOTAL_POINTS=$((TEST1_SCORE + TEST2_SCORE + TEST3_SCORE + AST_SCORE))
        echo "total_points=$TOTAL_POINTS" >> $GITHUB_OUTPUT
        
        # Ð¢Ð°ÐºÐ¶Ðµ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
        echo "TEST1_SCORE=$TEST1_SCORE" >> $GITHUB_ENV
        echo "TEST2_SCORE=$TEST2_SCORE" >> $GITHUB_ENV
        echo "TEST3_SCORE=$TEST3_SCORE" >> $GITHUB_ENV
        echo "AST_SCORE=$AST_SCORE" >> $GITHUB_ENV
        echo "TOTAL_POINTS=$TOTAL_POINTS" >> $GITHUB_ENV
    
    - name: Generate Test Report
      run: |
        # Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
        TEST1_SCORE="${TEST1_SCORE:-0}"
        TEST2_SCORE="${TEST2_SCORE:-0}"
        TEST3_SCORE="${TEST3_SCORE:-0}"
        AST_SCORE="${AST_SCORE:-0}"
        TOTAL_POINTS="${TOTAL_POINTS:-0}"
        
        # ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð±Ð°Ð»Ð»Ñ‹
        TEST1_MAX=17
        TEST2_MAX=17
        TEST3_MAX=16
        AST_MAX=5
        MAX_POINTS=$((TEST1_MAX + TEST2_MAX + TEST3_MAX + AST_MAX))
        
        # ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹
        get_status() {
          local score="$1"
          local max="$2"
          if [ "$score" -eq "$max" ]; then
            echo "âœ…"
          elif [ "$score" -gt 0 ]; then
            echo "âš ï¸"
          else
            echo "âŒ"
          fi
        }
        
        TEST1_STATUS=$(get_status "$TEST1_SCORE" "$TEST1_MAX")
        TEST2_STATUS=$(get_status "$TEST2_SCORE" "$TEST2_MAX")
        TEST3_STATUS=$(get_status "$TEST3_SCORE" "$TEST3_MAX")
        AST_STATUS=$(get_status "$AST_SCORE" "$AST_MAX")
        
        # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
        echo "## ðŸ¦ Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸: ÐšÐ»Ð°ÑÑ BankAccount" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ§ª Ð¢ÐµÑÑ‚Ñ‹ Ð²Ð²Ð¾Ð´Ð°-Ð²Ñ‹Ð²Ð¾Ð´Ð°" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Ð¢ÐµÑÑ‚ | Ð‘Ð°Ð»Ð»Ñ‹ | ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ | Ð¡Ñ‚Ð°Ñ‚ÑƒÑ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|-------|----------|--------|" >> $GITHUB_STEP_SUMMARY
        
        echo "| **ÐŸÐ¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÑÑ‡ÐµÑ‚Ð°** | $TEST1_SCORE | $TEST1_MAX | $TEST1_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "| **Ð¡Ð½ÑÑ‚Ð¸Ðµ ÑÑ€ÐµÐ´ÑÑ‚Ð²** | $TEST2_SCORE | $TEST2_MAX | $TEST2_STATUS |" >> $GITHUB_STEP_SUMMARY
        echo "| **ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ ÑÑ€ÐµÐ´ÑÑ‚Ð²** | $TEST3_SCORE | $TEST3_MAX | $TEST3_STATUS |" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ ÐºÐ»Ð°ÑÑÐ°" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| ÐšÑ€Ð¸Ñ‚ÐµÑ€Ð¸Ð¹ | Ð‘Ð°Ð»Ð»Ñ‹ | ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ | Ð¡Ñ‚Ð°Ñ‚ÑƒÑ |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| **AST Ð°Ð½Ð°Ð»Ð¸Ð· ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹** | $AST_SCORE | $AST_MAX | $AST_STATUS |" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°
        echo "### ðŸ“Š Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Ð’ÑÐµÐ³Ð¾ Ð±Ð°Ð»Ð»Ð¾Ð²:** **$TOTAL_POINTS / $MAX_POINTS**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Ð Ð°ÑÑ‡ÐµÑ‚ Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ð°
        if [ "$MAX_POINTS" -gt 0 ]; then
          PERCENTAGE=$((TOTAL_POINTS * 100 / MAX_POINTS))
        else
          PERCENTAGE=0
        fi
        
        # Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð°
        if [ "$TOTAL_POINTS" -eq "$MAX_POINTS" ]; then
          echo "ðŸŽ‰ **ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°! Ð’ÑÐµ Ñ‚ÐµÑÑ‚Ñ‹ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ñ‹!**" >> $GITHUB_STEP_SUMMARY
        elif [ "$PERCENTAGE" -ge 80 ]; then
          echo "ðŸ‘ **Ð¥Ð¾Ñ€Ð¾ÑˆÐ¸Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚!**" >> $GITHUB_STEP_SUMMARY
        elif [ "$PERCENTAGE" -ge 60 ]; then
          echo "âš ï¸ **Ð•ÑÑ‚ÑŒ Ð½Ð°Ð´ Ñ‡ÐµÐ¼ Ð¿Ð¾Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ.**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **ÐÑƒÐ¶Ð½Ð¾ ÑÐµÑ€ÑŒÐµÐ·Ð½Ð¾ Ð¿Ð¾Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð½Ð°Ð´ Ð·Ð°Ð´Ð°Ð½Ð¸ÐµÐ¼.**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°*" >> $GITHUB_STEP_SUMMARY

    - name: Autograding Reporter
      id: reporter
      uses: classroom-resources/autograding-grading-reporter@v1
      env:
        TEST1_RESULTS: "${{ steps.test1.outputs.result }}"
        TEST2_RESULTS: "${{ steps.test2.outputs.result }}"
        TEST3_RESULTS: "${{ steps.test3.outputs.result }}"
      with:
        runners: test1,test2,test3

  # JOB 2: Ð›Ð¸Ð½Ñ‚ÐµÑ€Ñ‹
  run-linters:
    runs-on: ubuntu-latest
    name: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð´Ð°
    if: always()
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install linters
      run: |
        echo "## ðŸ” ÐÐ½Ð°Ð»Ð¸Ð· ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° ÐºÐ¾Ð´Ð°" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        pip install pylint -q
      
    - name: Run linters
      run: |
        if [ -f "task.py" ]; then
          echo "### ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° task.py" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          pylint task.py --exit-zero 2>&1 | tail -10 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "Ð¤Ð°Ð¹Ð» task_Bank.py Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½" >> $GITHUB_STEP_SUMMARY
        fi
